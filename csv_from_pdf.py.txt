import os
import csv
from datetime import datetime
from PyPDF2 import PdfReader

today = datetime.now()
PDF_DIR = os.path.join("Downloads", today.strftime("%Y"), today.strftime("%b"))
CSV_DIR = "csv"

def sanitize_filename(text):
    return text.replace("/", "-").replace("\"", "").replace(",", "").replace(":", "").replace(" ", "_")

def extract_table_data(pdf_path):
    reader = PdfReader(pdf_path)
    text = ""
    for page in reader.pages:
        text += page.extract_text()

    lines = text.splitlines()

    data_rows = []
    current_date = extract_date_from_text(text)

    for line in lines:
        if line.strip().startswith("1.") or line.strip().startswith("2.") or line.strip().startswith("3."):
            parts = line.strip().split()
            # Try parsing last part as price
            try:
                price = int(parts[-1].replace(",", ""))
                desc = " ".join(parts[1:-1])
                data_rows.append((current_date, desc, price))
            except:
                continue

    return data_rows

def extract_date_from_text(text):
    import re
    match = re.search(r'w\.e\.f\.\s*(\d{2}\.\d{2}\.\d{4})', text)
    if match:
        date_obj = datetime.strptime(match.group(1), "%d.%m.%Y")
        return date_obj.strftime("%Y-%m-%d")
    return datetime.now().strftime("%Y-%m-%d")

def append_to_csv(row):
    date, desc, price = row
    filename = sanitize_filename(desc) + ".csv"
    csv_path = os.path.join(CSV_DIR, filename)

    os.makedirs(CSV_DIR, exist_ok=True)

    # Check for duplicates
    if os.path.exists(csv_path):
        with open(csv_path, "r", newline="") as f:
            if any(date in line for line in f):
                return  # already updated for this date

    with open(csv_path, "a", newline="") as f:
        writer = csv.writer(f)
        writer.writerow([date, desc, price])

def process_pdf(pdf_path):
    extracted_rows = extract_table_data(pdf_path)
    for row in extracted_rows:
        append_to_csv(row)

if __name__ == "__main__":
    target_pdf = os.path.join(PDF_DIR, "primary-ready-reckoner-31-may-2025.pdf")
    if os.path.exists(target_pdf):
        process_pdf(target_pdf)
        print(f"✅ Processed and updated CSVs from: {target_pdf}")
    else:
        print("❌ PDF not found.")
